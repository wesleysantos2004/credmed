<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Minhas Solicitações - Portal do Médico</title>

    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    <!-- Custom CSS -->
    <link rel="stylesheet" href="../assets/css/custom.css">
</head>

<body>

    <!-- Mobile Header -->
    <div class="mobile-header">
        <button class="menu-toggle" onclick="toggleMobileMenu()">
            <i class="bi bi-list"></i>
        </button>
        <h5 class="text-primary fw-bold flex-grow-1 text-center">
            <i class="bi bi-person-badge me-2"></i>Portal Médico
        </h5>
        <div style="width: 40px;"></div>
    </div>

    <!-- Sidebar Overlay -->
    <div class="sidebar-overlay"></div>

    <!-- Sidebar -->
    <div class="sidebar">
        <div class="px-3 mb-4">
            <h5 class="text-primary fw-bold mb-0">
                <i class="bi bi-person-badge me-2"></i>Portal Médico
            </h5>
        </div>
        <nav class="nav flex-column">
            <a class="nav-link" href="dashboard.html">
                <i class="bi bi-house-door"></i>
                Dashboard
            </a>
            <a class="nav-link" href="nova-solicitacao.html">
                <i class="bi bi-plus-circle"></i>
                Nova Solicitação
            </a>
            <a class="nav-link active" href="lista-solicitacoes.html">
                <i class="bi bi-list-ul"></i>
                Minhas Solicitações
            </a>
            <a class="nav-link" href="perfil.html">
                <i class="bi bi-person"></i>
                Meu Perfil
            </a>
            <hr class="my-3">
            <a class="nav-link text-danger" href="#" onclick="logout()">
                <i class="bi bi-box-arrow-right"></i>
                Sair
            </a>
        </nav>
    </div>

    <!-- Main Content -->
    <div class="main-content">
        <!-- Header -->
        <div class="d-flex justify-content-between align-items-center mb-4 flex-wrap gap-3">
            <div>
                <h2 class="mb-1">Minhas Solicitações</h2>
                <p class="text-muted mb-0">Acompanhe o status de todas as suas solicitações</p>
            </div>
            <button class="btn btn-primary" onclick="window.location.href='nova-solicitacao.html'">
                <i class="bi bi-plus-circle me-2"></i>
                Nova Solicitação
            </button>
        </div>

        <!-- Filters -->
        <div class="card card-custom mb-4">
            <div class="card-body">
                <div class="row g-3">
                    <div class="col-md-3">
                        <label for="filtroStatus" class="form-label small">Status</label>
                        <select class="form-select" id="filtroStatus" onchange="aplicarFiltros()">
                            <option value="">Todos</option>
                            <option value="AGUARDANDO_VALIDACAO_EMPRESA">Aguardando Empresa</option>
                            <option value="EM_APROVACAO_ADMIN">Em Aprovação</option>
                            <option value="APROVADO">Aprovado</option>
                            <option value="PAGO">Pago</option>
                            <option value="REJEITADO">Rejeitado</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label for="filtroDataInicio" class="form-label small">Data Inicial</label>
                        <input type="date" class="form-control" id="filtroDataInicio" onchange="aplicarFiltros()">
                    </div>
                    <div class="col-md-3">
                        <label for="filtroDataFim" class="form-label small">Data Final</label>
                        <input type="date" class="form-control" id="filtroDataFim" onchange="aplicarFiltros()">
                    </div>
                    <div class="col-md-3">
                        <label for="filtroBusca" class="form-label small">Buscar</label>
                        <input type="text" class="form-control" id="filtroBusca" placeholder="Protocolo ou empresa..."
                            onkeyup="aplicarFiltros()">
                    </div>
                </div>
            </div>
        </div>

        <!-- Summary Cards -->
        <div class="row g-3 mb-4">
            <div class="col-6 col-md-3">
                <div class="card border-warning">
                    <div class="card-body p-3">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <div class="small text-muted">Aguardando</div>
                                <h4 class="mb-0 text-warning" id="countAguardando">0</h4>
                            </div>
                            <i class="bi bi-clock-history fs-3 text-warning"></i>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-6 col-md-3">
                <div class="card border-info">
                    <div class="card-body p-3">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <div class="small text-muted">Em Aprovação</div>
                                <h4 class="mb-0 text-info" id="countAprovacao">0</h4>
                            </div>
                            <i class="bi bi-hourglass-split fs-3 text-info"></i>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-6 col-md-3">
                <div class="card border-success">
                    <div class="card-body p-3">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <div class="small text-muted">Aprovadas</div>
                                <h4 class="mb-0 text-success" id="countAprovado">0</h4>
                            </div>
                            <i class="bi bi-check-circle fs-3 text-success"></i>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-6 col-md-3">
                <div class="card border-primary">
                    <div class="card-body p-3">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <div class="small text-muted">Total</div>
                                <h4 class="mb-0 text-primary" id="countTotal">0</h4>
                            </div>
                            <i class="bi bi-list-check fs-3 text-primary"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Solicitações List -->
        <div class="card card-custom">
            <div class="card-body">
                <h5 class="card-title mb-4">
                    <i class="bi bi-file-text me-2"></i>
                    Todas as Solicitações
                </h5>

                <!-- Desktop Table -->
                <div class="table-responsive d-none d-md-block">
                    <table class="table table-hover align-middle">
                        <thead>
                            <tr>
                                <th>Protocolo</th>
                                <th>Empresa</th>
                                <th>Plantões</th>
                                <th>Valor Total</th>
                                <th>Valor Líquido</th>
                                <th>Data</th>
                                <th>Status</th>
                                <th>Ações</th>
                            </tr>
                        </thead>
                        <tbody id="solicitacoesTableBody">
                            <tr>
                                <td colspan="8" class="text-center text-muted py-4">
                                    <i class="bi bi-inbox fs-1 d-block mb-2"></i>
                                    Carregando solicitações...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <!-- Mobile Cards -->
                <div class="d-md-none" id="solicitacoesMobileList">
                    <div class="text-center text-muted py-4">
                        <i class="bi bi-inbox fs-1 d-block mb-2"></i>
                        Carregando solicitações...
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap 5 JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <!-- Custom JS -->
    <script src="../assets/js/app.js"></script>
    <script src="../assets/js/storage.js"></script>

    <script>
        checkAuth('medico');

        let todasSolicitacoes = [];
        let solicitacoesFiltradas = [];

        // Carregar do storage
        function loadFromStorage() {
            console.log('Carregando solicitações do médico medico1...');
            const solicitacoesStorage = AppStorage.getSolicitacoesMedico('medico1');
            console.log('Solicitações encontradas:', solicitacoesStorage);
            return solicitacoesStorage.map(s => ({
                id: s.id,
                numero: s.numero,
                empresa: s.empresaNome,
                valorTotal: s.valorTotal,
                valorLiquido: s.valorLiquido,
                status: s.status,
                dataSolicitacao: s.dataCriacao,
                plantoes: s.plantoes ? s.plantoes.length : 0
            }));
        }

        // Status mapping
        const statusConfig = {
            'AGUARDANDO_TRIAGEM_ADMIN': {
                label: 'Aguardando Triagem',
                badge: 'bg-warning text-dark',
                icon: 'hourglass-split'
            },
            'AGUARDANDO_VALIDACAO_EMPRESA': {
                label: 'Aguardando Empresa',
                badge: 'bg-info',
                icon: 'building'
            },
            'VALIDADO_EMPRESA': {
                label: 'Validado pela Empresa',
                badge: 'bg-primary',
                icon: 'check-circle'
            },
            'REJEITADO_EMPRESA': {
                label: 'Rejeitado pela Empresa',
                badge: 'bg-danger',
                icon: 'x-circle'
            },
            'APROVADO_ADMIN': {
                label: 'Aprovado - Aguardando Pagamento',
                badge: 'bg-success',
                icon: 'check-circle'
            },
            'REJEITADO_ADMIN': {
                label: 'Rejeitado',
                badge: 'bg-danger',
                icon: 'x-circle'
            },
            'AGUARDANDO_INFORMACOES_MEDICO': {
                label: 'Aguardando Suas Informações',
                badge: 'bg-warning text-dark',
                icon: 'question-circle'
            },
            'PAGO': {
                label: 'Pago',
                badge: 'bg-success',
                icon: 'cash-coin'
            },
            // Mantém os antigos para compatibilidade
            'EM_APROVACAO_ADMIN': {
                label: 'Em Aprovação',
                badge: 'bg-info',
                icon: 'hourglass-split'
            },
            'APROVADO': {
                label: 'Aprovado',
                badge: 'bg-success',
                icon: 'check-circle'
            },
            'REJEITADO': {
                label: 'Rejeitado',
                badge: 'bg-danger',
                icon: 'x-circle'
            }
        };

        // Load solicitações
        function loadSolicitacoes() {
            console.log('=== Iniciando loadSolicitacoes ===');
            // Tentar carregar do storage primeiro
            const storageSolicitacoes = loadFromStorage();
            console.log('Resultado de loadFromStorage:', storageSolicitacoes);

            if (storageSolicitacoes.length > 0) {
                console.log('Usando dados do storage');
                todasSolicitacoes = storageSolicitacoes;
            } else {
                console.log('Storage vazio, usando mock data');
                // Se não houver no storage, usar mock
                todasSolicitacoes = [
                    {
                        id: 'SOL-2025-00042',
                        numero: 'SOL-2025-00042',
                        status: 'AGUARDANDO_VALIDACAO_EMPRESA',
                        valorTotal: 3500.00,
                        valorLiquido: 3377.50,
                        dataSolicitacao: '2025-12-26T14:30:00',
                        plantoes: 2,
                        empresa: 'MedPlus'
                    },
                    {
                        id: 'SOL-2025-00038',
                        numero: 'SOL-2025-00038',
                        status: 'PAGO',
                        valorTotal: 5200.00,
                        valorLiquido: 5018.00,
                        dataSolicitacao: '2025-12-20T10:15:00',
                        dataPagamento: '2025-12-23T16:30:00',
                        plantoes: 3,
                        empresa: 'MedPlus'
                    },
                    {
                        id: 'SOL-2025-00035',
                        numero: 'SOL-2025-00035',
                        status: 'EM_APROVACAO_ADMIN',
                        valorTotal: 4200.00,
                        valorLiquido: 4053.00,
                        dataSolicitacao: '2025-12-18T09:20:00',
                        plantoes: 2,
                        empresa: 'Hospital Vida'
                    },
                    {
                        id: 'SOL-2025-00029',
                        numero: 'SOL-2025-00029',
                        status: 'APROVADO',
                        valorTotal: 2800.00,
                        valorLiquido: 2702.00,
                        dataSolicitacao: '2025-12-15T11:45:00',
                        plantoes: 2,
                        empresa: 'Clínica Saúde'
                    },
                    {
                        id: 'SOL-2025-00021',
                        numero: 'SOL-2025-00021',
                        status: 'PAGO',
                        valorTotal: 6100.00,
                        valorLiquido: 5886.50,
                        dataSolicitacao: '2025-12-10T15:10:00',
                        dataPagamento: '2025-12-14T10:20:00',
                        plantoes: 4,
                        empresa: 'MedPlus'
                    },
                    {
                        id: 'SOL-2025-00015',
                        numero: 'SOL-2025-00015',
                        status: 'REJEITADO',
                        valorTotal: 3000.00,
                        valorLiquido: 2895.00,
                        dataSolicitacao: '2025-12-05T08:30:00',
                        plantoes: 2,
                        empresa: 'Hospital Vida',
                        motivoRejeicao: 'Documentação incompleta'
                    }
                ];
            }

            solicitacoesFiltradas = [...todasSolicitacoes];
            renderizarSolicitacoes();
            atualizarContadores();
        }

        function aplicarFiltros() {
            const filtroStatus = document.getElementById('filtroStatus').value;
            const filtroDataInicio = document.getElementById('filtroDataInicio').value;
            const filtroDataFim = document.getElementById('filtroDataFim').value;
            const filtroBusca = document.getElementById('filtroBusca').value.toLowerCase();

            solicitacoesFiltradas = todasSolicitacoes.filter(sol => {
                // Filtro status
                if (filtroStatus && sol.status !== filtroStatus) return false;

                // Filtro data início
                if (filtroDataInicio && new Date(sol.dataSolicitacao) < new Date(filtroDataInicio)) return false;

                // Filtro data fim
                if (filtroDataFim && new Date(sol.dataSolicitacao) > new Date(filtroDataFim + 'T23:59:59')) return false;

                // Filtro busca
                if (filtroBusca) {
                    const searchText = `${sol.numero} ${sol.empresa}`.toLowerCase();
                    if (!searchText.includes(filtroBusca)) return false;
                }

                return true;
            });

            renderSolicitacoes(solicitacoesFiltradas);
        }

        function renderSolicitacoes(solicitacoes) {
            const tbody = document.getElementById('solicitacoesTableBody');
            const mobileList = document.getElementById('solicitacoesMobileList');

            if (solicitacoes.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="8" class="text-center text-muted py-4">
                            <i class="bi bi-inbox fs-1 d-block mb-2"></i>
                            Nenhuma solicitação encontrada
                        </td>
                    </tr>
                `;
                mobileList.innerHTML = `
                    <div class="text-center text-muted py-4">
                        <i class="bi bi-inbox fs-1 d-block mb-2"></i>
                        Nenhuma solicitação encontrada
                    </div>
                `;
                return;
            }

            // Desktop table
            tbody.innerHTML = solicitacoes.map(sol => {
                const status = statusConfig[sol.status] || statusConfig['AGUARDANDO_VALIDACAO_EMPRESA'];
                return `
                    <tr>
                        <td><strong>${sol.numero}</strong></td>
                        <td>${sol.empresa}</td>
                        <td>${sol.plantoes} plantões</td>
                        <td><strong>${formatCurrency(sol.valorTotal)}</strong></td>
                        <td><strong class="text-success">${formatCurrency(sol.valorLiquido)}</strong></td>
                        <td>${formatDate(sol.dataSolicitacao)}</td>
                        <td>
                            <span class="badge ${status.badge}">
                                <i class="bi bi-${status.icon} me-1"></i>
                                ${status.label}
                            </span>
                        </td>
                        <td>
                            <button class="btn btn-sm btn-outline-primary" 
                                    onclick="window.location.href='detalhes-solicitacao.html?id=${sol.id}'">
                                <i class="bi bi-eye"></i>
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');

            // Mobile cards
            mobileList.innerHTML = solicitacoes.map(sol => {
                const status = statusConfig[sol.status] || statusConfig['AGUARDANDO_VALIDACAO_EMPRESA'];
                return `
                    <div class="card mb-3" onclick="window.location.href='detalhes-solicitacao.html?id=${sol.id}'" 
                         style="cursor: pointer;">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-start mb-2">
                                <strong class="text-primary">${sol.numero}</strong>
                                <span class="badge ${status.badge}">
                                    <i class="bi bi-${status.icon} me-1"></i>
                                    ${status.label}
                                </span>
                            </div>
                            <div class="mb-2">
                                <small class="text-muted">${sol.empresa}</small>
                            </div>
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <small class="text-muted d-block">Valor Líquido</small>
                                    <strong class="text-success">${formatCurrency(sol.valorLiquido)}</strong>
                                </div>
                                <div class="text-end">
                                    <small class="text-muted d-block">Data</small>
                                    <small>${formatDate(sol.dataSolicitacao)}</small>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function atualizarContadores() {
            const aguardando = todasSolicitacoes.filter(s =>
                s.status === 'AGUARDANDO_TRIAGEM_ADMIN' ||
                s.status === 'AGUARDANDO_VALIDACAO_EMPRESA' ||
                s.status === 'AGUARDANDO_INFORMACOES_MEDICO'
            ).length;

            const aprovacao = todasSolicitacoes.filter(s =>
                s.status === 'VALIDADO_EMPRESA' ||
                s.status === 'EM_APROVACAO_ADMIN'
            ).length;

            const aprovado = todasSolicitacoes.filter(s =>
                s.status === 'APROVADO' ||
                s.status === 'APROVADO_ADMIN' ||
                s.status === 'PAGO'
            ).length;

            document.getElementById('countAguardando').textContent = aguardando;
            document.getElementById('countAprovacao').textContent = aprovacao;
            document.getElementById('countAprovado').textContent = aprovado;
            document.getElementById('countTotal').textContent = todasSolicitacoes.length;
        }

        // Initialize
        loadSolicitacoes();
    </script>
</body>

</html>